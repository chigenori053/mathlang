# MathLang テスト計画書

## 1. 目的

本計画は、MathLangのデモ版リリースに向けて、新たに追加される機能の品質を保証することを目的とします。
`docs/task_management_sheet.md` のタスクに基づき、特に以下の項目に焦点を当てます。

- **P2-05: 多項式四則演習スクリプト**: `SymbolicEngine` と連携した多項式演算機能の品質保証。
- **P3-01: JupyterLabデモノートブック**: デモ用Notebookのシナリオが正常に実行できることの確認。
- **P3-02: 学習ログ導出API**: 評価過程のログ出力機能が正しく動作することの確認。

## 2. テスト対象と範囲

### 対象機能
- `core/evaluator.py` と `core/symbolic_engine.py` を連携させた多項式演算機能。
- `main.py` の `--symbolic-trace` オプションを用いたシンボリック実行結果。
- `examples/` 配下に作成されるJupyter Notebookデモ。
- `Evaluator` からの学習ログ（JSON形式）出力機能。

### 範囲外
- 本計画では、完了済みであるPhase 1の機能（基本的なパーサー、評価器）に関するリグレッションテストは含みますが、新規のテストケース追加は対象外とします。

## 3. テスト方針

| テスト種別 | アプローチ | 対象 |
|------------|------------|------|
| **単体テスト** | `pytest` を用いて、関数やクラス単位でロジックの正しさを検証する。 | ・多項式の加減乗除を行う`Evaluator`の新ロジック<br>・学習ログを生成するAPI |
| **結合テスト** | CLIから `.mlang` ファイルを実行し、各コンポーネント（Parser, Optimizer, Evaluator, SymbolicEngine）が連携して動作することを検証する。 | ・`main.py --symbolic-trace` を使った多項式演習スクリプトの実行 |
| **シナリオテスト** | Jupyter Notebook上で、エンドユーザーの利用シナリオに沿って一連の操作を行い、システム全体の動作を検証する。 | ・`examples/` のデモノートブック（Hello World, 多項式四則演習） |
| **環境テスト** | 開発環境およびCI環境で、すべてのテストが成功することを確認する。 | ・`uv` で管理された依存関係<br>・devcontainer, CI環境 |

## 4. テスト項目

### P2-05: 多項式四則演習

| ID | テスト項目 | 期待される結果 | 種別 |
|----|------------|----------------|------|
| TC-P205-01 | 多項式の加算 (`(x + 1) + (x + 2)`) | `2*x + 3` のような簡約化された結果が得られる。 | 単体/結合 |
| TC-P205-02 | 多項式の減算 (`(2*x - 1) - (x - 1)`) | `x` のような簡約化された結果が得られる。 | 単体/結合 |
| TC-P205-03 | 多項式の乗算 (`(x + 1) * (x - 1)`) | `x**2 - 1` のような展開・簡約化された結果が得られる。 | 単体/結合 |
| TC-P205-04 | 多項式の除算 (`(x**2 - 1) / (x + 1)`) | `x - 1` のような簡約化された結果が得られる。 | 単体/結合 |
| TC-P205-05 | 失敗系: ゼロ除算 | `Division by zero` エラーが適切に報告される。 | 単体 |
| TC-P205-06 | CLIからのシンボリック実行 | `--symbolic-trace` 付きで実行した際に、計算過程がSymPy形式で表示される。 | 結合 |

### P3-01: JupyterLabデモノートブック

| ID | テスト項目 | 期待される結果 | 種別 |
|----|------------|----------------|------|
| TC-P301-01 | Notebookの実行 | Notebookの全セルを先頭から実行（"Run All"）した際に、エラーが発生しない。 | シナリオ |
| TC-P301-02 | Hello World シナリオ | `show 'Hello World'` の実行結果が正しく表示される。 | シナリオ |
| TC-P301-03 | 多項式演習シナリオ | Notebook上で定義した多項式演算が実行され、期待通りの結果が表示される。 | シナリオ |

### P3-02: 学習ログ導出API

| ID | テスト項目 | 期待される結果 | 種別 |
|----|------------|----------------|------|
| TC-P302-01 | ログ出力APIの呼び出し | `Evaluator` の拡張メソッドを呼び出すと、JSON形式の文字列が返される。 | 単体 |
| TC-P302-02 | ログ内容の検証 | 出力されたJSONに、実行されたASTノードの情報や評価結果が含まれている。 | 単体 |

## 5. スケジュール

`docs/task_management_sheet.md` の期限に基づき、以下のスケジュールでテストを遂行する。

- **〜2025/12/02**: P2-05（多項式四則演習）の単体・結合テストを `tests/` 配下に実装完了。
- **〜2025/12/15**: P3-01, P3-02（Jupyter Notebook, 学習ログ）のシナリオテストおよび単体テストを実装完了。
- **〜2025/12/27**: 全機能の最終的なリグレッションテストおよびデモパッケージの動作確認。

## 6. リスクと対策

| リスク | 対策 |
|--------|------|
| SymPyのAPI非互換性や仕様変更により、シンボリック実行が失敗する。 | 依存ライブラリのバージョンを `uv.lock` で固定し、CIで継続的に動作を監視する。 |
| Jupyter Notebookの実行環境差異により、デモが再現できない。 | `devcontainer` を提供し、ドキュメントに記載された手順で誰でも同じ環境を構築できるようにする。 |
| テストケースの実装が遅延し、品質保証が不十分になる。 | 優先度の高いシナリオ（多項式演習）からテストを実装し、カバレッジを段階的に向上させる。 |
